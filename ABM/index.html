<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../esp1FormVariableArregloDeObj/styles.css">
    <link rel="stylesheet" href="../esp2TablaVariableArregloDeObj/styles2.css">
    <link rel="stylesheet" href="./ej3.css">
    <title>Ej ABM</title>
</head>

<body>

    <div id="mainPage" class="visibleOn">
        <header>
            <div class="test">
                <h2>CRUD</h2>
            </div>
            <div>
                Ordenado por : <input type="text" id="criteria" readonly></input>
                <button class="boton" onclick="load('id')">Cargar datos</button>
                <button class="boton" id="btnClean">Limpiar tabla</button>
                <button class="boton" onclick="showModal(1)">Cargar nuevo</button>
            </div>
        </header>

        <div class="container">
            <table>
                <thead>
                    <tr>
                        <th class="title" onclick="load('id')">Cod. Art.</th>
                        <th class="title" onclick="load('tipo')">Tipo</th>
                        <th class="title" onclick="load('um')">Unidad</th>
                        <th class="title" onclick="load('description')">Descripcion</th>
                        <th class="title" onclick="load('fecha')">Fecha</th>
                        <th class="title" onclick="load('stock')">Stock</th>
                        <th style="width: 8%;">Modificacion</th>
                        <th style="width: 8%;">Borrar</th>
                    </tr>
                    <tr>
                        <th></th>
                        <th><input type="text" id="fil_tipo"></th>
                        <th><input type="text" id="fil_um"></th>
                        <th><input type="text" id="fil_description"></th>
                        <th><input type="text" id="fil_fecha"></th>
                        <th><input type="text" id="fil_stock"></th>
                        <th></th><th></th>
                    </tr>
                </thead>
                <tbody id="tbody">

                </tbody>
            </table>
        </div>

        <footer>
            <div style="padding-left: 10px">
                Cantidad de articulos:
                <span id="counter"></span>
            </div>
            <div>
                <h2>Soroka Nicol√°s</h2>
            </div>
        </footer>
    </div>


    <div id="modalPage" class="visibleOff">
        <form id="formulario" method="POST">
                <div class="contenedor">
                    <div class="izq">
                        <div class="elemento">
                            <label for="">codArt:</label>
                            <input type="text" name="cod" id="cod_mod" readonly required>
                        </div>
                        <div class="elemento">
                            <label for="">Descripcion</label>
                            <input type="text" name="description" id="description_mod" required>
                        </div>
                        <div class="elemento">
                            <label for="">Saldo stock</label>
                            <input type="number" name="stock" required id="stock_mod">
                        </div>
                    </div>

                    <div class="der">
                        <div class="elemento">
                            <label for="">Tipo</label>
                            <select id="select_opt" required>
                            </select>
                        </div>
                        <div class="elemento">
                            <label for="">UM</label>
                            <input type="text" name="um" required id="um_mod">
                        </div>
                        <div class="elemento">
                            <label for="">Fecha de alta</label>
                            <input type="text" name="date" id="fecha_mod" readonly>
                        </div>
                    </div>
                </div>
        </form>
        <div style="text-align: center; margin-top: 10px;">
            <button id = "btnupdate" onclick="update()">Actualizar</button>
            <button id = "btnadd" onclick="add()">Agregar</button>
            <button id = "btnModalClose">Cerrar modal</button>
        </div>
    </div>
</body>
</html>

<script type="text/javascript" src="../jquery-3.5.1.min.js"></script>

<script>

    function getOpt(){
        $("#select_opt").empty();
        $.ajax({
            type: "POST",
            url: "./get_opt.php",
            success: function(resp) {
                arrjson = JSON.parse(resp);
                arrjson.forEach(element => { 
                    $("#select_opt").append("<option value='" + element + "'>" + element + "</option>"); });
            }
        });}

    $("#btnClean").click(function() {
        $("#tbody").empty();
    });

    $("#btnModalClose").click(function() {
        $("#modalPage").attr("class", "visibleOff")
        $("#mainPage").attr("class", "usableOn")
        document.getElementById('btnadd').style.visibility = 'hidden';
        document.getElementById('btnupdate').style.visibility = 'hidden';
    });

    function showModal(n) {
        $("#mainPage").attr("class", "usableOff")
        $("#modalPage").attr("class", "visibleOn")

        $('#stock_mod').val("");
        $('#description_mod').val("");
        $('#um_mod').val("");
        $('#select_opt').val("");
        getOpt();
       
        var d = new Date().toISOString().substr(0, 10);
        $('#fecha_mod').val(d);

        if (n==1)
        {
            document.getElementById('btnadd').style.visibility = 'visible';
            document.getElementById('btnupdate').style.visibility = 'hidden';

            $.ajax ({
                type: "POST",
                url: "./max.php",

                success: function(ret) {
                    if ($.isNumeric(ret))
                    $('#cod_mod').val(parseInt(ret)+1);
                    
                    else
                    $('#cod_mod').val('1');
                }
            })
        }
        else {
            document.getElementById('btnadd').style.visibility = 'hidden';
            document.getElementById('btnupdate').style.visibility = 'visible';
        }
    }

    function load(crit) {
        $("#criteria").val(crit);
        $.ajax({
            type: "POST",
            url: "./get.php",
            data: {
                entrada: crit,
                tipo:  $("#fil_tipo").val(),
                um : $("#fil_um").val(),
                description : $("#fil_description").val(),
                fecha : $("#fil_fecha").val(),
                stock : $("#fil_stock").val()
                },
           
            success: function(respuesta) {
                varjson = JSON.parse(respuesta);
                var tmpPersona = "";

                varjson.articulos.forEach(element => {
                    tmpPersona += "<tr>" +
                        "<td>" + element.id + "</td>" +
                        "<td>" + element.tipo + "</td>" +
                        "<td>" + element.um + "</td>" +
                        "<td>" + element.description + "</td>" +
                        "<td>" + element.fecha + "</td>" +
                        "<td>" + element.stock + "</td>" +
                        '<td style="width: 7%;"><button onclick="get_item(' + element.id + ')">Modificar</button></td>' +
                        '<td style="width: 7%;"><button onclick="delete_(' + element.id + ')">Eliminar</button></td>'
                    "</tr>";
                });
                $("#tbody").empty();
                $("#tbody").append(tmpPersona);
                $("#counter").empty();
                $("#counter").append(varjson.cantidad);
            }
    });
    }

    function add() {

        if (! ($('#fecha_mod').val() && $('#stock_mod').val() && $('#description_mod').val() && $('#um_mod').val())) {
                alert("Debe completar todos los campos");
                return;
        }

        var info = {
            "cod": $('#cod_mod').val(),
            "fecha": $('#fecha_mod').val(),
            "stock": $('#stock_mod').val(),
            "description": $('#description_mod').val(),
            "um": $('#um_mod').val(),
            "tipo": $('#select_opt').val()
        };

        $.ajax({
            type: "POST",
            url: "./save.php",
            data: info,

            success: function() {
                alert("Agregado! " + info.cod);
                load("id");
            }
        })
    }

    function update() {
        if (! ($('#fecha_mod').val() && $('#stock_mod').val() && $('#description_mod').val() && $('#um_mod').val())) {
                alert("Debe completar todos los campos");
                return;
        }

        var info = {
            "cod": $('#cod_mod').val(),
            "stock": $('#stock_mod').val(),
            "description": $('#description_mod').val(),
            "um": $('#um_mod').val(),
            "tipo": $('#select_opt').val()
        };

        $.ajax({
            type: "POST",
            url: "./update.php",
            data: info,

            success: function() {
                alert("Actualizado: " + $('#cod_mod').val());
                load("id");
            }
        })
    }

    function delete_(id) {
        $.ajax({
            type: "POST",
            url: "./delete.php",
            data: {
                entrada: id
            },
            success: function() {
                alert("Eliminado : " + id);
                load("id");
            }
        })
    }


    function get_item(id) {
        showModal();

        $.ajax({
            type: "POST",
            url: "./get_1.php",
            data: {
                entrada: id
            },

            success: function(obj, estado) {
                varjson = JSON.parse(obj);

                $('#fecha_mod').val(varjson.fecha_alta);
                $('#stock_mod').val(varjson.stock);
                $('#cod_mod').val(varjson.codArt);
                $('#description_mod').val(varjson.description);
                $('#um_mod').val(varjson.um);
                $('#select_opt').val(varjson.tipo);
            }
        });
    }
</script>